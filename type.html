<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Typing Speed Test</title>
  <link href="./st.css" rel="stylesheet">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
</head>    
<body>
  <header>
  <div id="plate" >
      <img src="../image/image-removebg-preview (30).png">
  </div>
  </header>
  <h1 class="fast">Prove Your are the <span>Fastest</span></h1>
  <div id="timer"> <div id="highwpm"><span id="trophy"><i class="fa-solid fa-trophy"></i></span></i><p>Highest WPM : <span id="hw"> 0 </p></div>
   <span id="timerr">60s</span> 
  </div> 
  <div class="typing-container">
    <div id="para"><span class="cursor">|</span></div>
    <textarea id="typed" placeholder="" spellcheck="false"></textarea>
</div>
  <div id="resultPopup" class="popupoverlay">
  <div class="popupbox">
   <h2 id="resu">RESULTS</h2>
   <hr>
   <div id="words">
    <p>Accuracy <br><span id="acc"></span></p>
    <p>WPM<br> <span id="wpm"></span></p>
    <p>Errors<br> <span id="err"></span></p>
    
    </div>
        <button id="rbt">retry</button>
         <button id="okBtn">OK</button>

  </div>
 
</div>
  <br>
  <script>
    let currentParagraph = '';
    let timeLeft = 60;
    let timerInterval = null;
    let testStarted = false;
    let startTime = null;
    
    async function loadParagraph() {
      const res = await fetch('http://127.0.0.1:5000/api/para');
      const data = await res.json();
      currentParagraph = data.paragraph;
      document.getElementById('para').innerText = currentParagraph;
    }

    let bestWPM = localStorage.getItem('hw') || 0;
document.getElementById('hw').innerText = bestWPM;

  async function calculate() { 
  clearInterval(timerInterval); 
  document.getElementById('typed').disabled = true; 
 
  const typed = document.getElementById('typed').value; 
  const actualTime = Math.floor((Date.now() - startTime) / 1000); 
 
  const res = await fetch('http://127.0.0.1:5000/api/calculate', { 
    method: 'POST', 
    headers: {'Content-Type': 'application/json'}, 
    body: JSON.stringify({  
      typed: typed,  
      original: currentParagraph, 
      time: actualTime 
    }) 
  }); 
 
  const data = await res.json(); 
 const cursor = '<span class="cursor">|</span>';

const para = document.getElementById('para');
const typedInput = document.getElementById('typed');
let cursorIndex = 0;

function updateCursor() {
   
    const text = currentParagraph || ""; 
    let display = text.slice(0, cursorIndex) + '<span class="cursor">|</span>' + text.slice(cursorIndex);
    para.innerHTML = display;
}
typedInput.addEventListener('input', (e) => {
    cursorIndex = e.target.value.length; 
    updateCursor();
});

updateCursor();
document.getElementById('typed').addEventListener('input', (e) => {
    const typedLength = e.target.value.length;
    cursorIndex = typedLength; 
    updateCursor();
});


updateCursor();

  document.getElementById('acc').innerText = `${data.accuracy}%`; 
  document.getElementById('wpm').innerText = data.wpm; 
  document.getElementById('err').innerText = data.errors; 
 
   if (data.wpm > bestWPM) {
    bestWPM = data.wpm;
    localStorage.setItem('hw', bestWPM);
    document.getElementById('hw').innerText = bestWPM;
  }

  document.getElementById('resultPopup').style.display = 'flex'; 
  const okb = document.getElementById('okBtn');
  okb.addEventListener('click',()=>{

    document.getElementById('resultPopup').style.display = 'none'; 
  })
}
    document.getElementById('typed').addEventListener('input', function(e) {
      const typed = e.target.value;
      const target = currentParagraph;
      

      let highlightedText = '';
      for (let i = 0; i < target.length; i++) {
        if (i < typed.length) {
          if (typed[i] === target[i]) {
            highlightedText += `<span class="correct">${target[i]}</span>`;
          } 
          else {
            highlightedText += `<span class="wrong">${target[i]}</span>`;
          }
          
        }
        else if (i === typed.length) {
 
            highlightedText += `<span class="cursor">|</span>${target[i]}`;
        }
         else {
          highlightedText += target[i];
        }
         if (typed.length >= target.length) {
        highlightedText += `<span class="cursor">|</span>`;
    }

    para.innerHTML = highlightedText;
      }
      document.getElementById('para').innerHTML = highlightedText;
      
      if (!testStarted) {
        testStarted = true;
        startTime = Date.now();
        startTimer();
      }
    });

    function startTimer() {
      const timerDisplay = document.getElementById('timerr');
      
      timerInterval = setInterval(() => {
        timeLeft--;
        timerDisplay.innerText = timeLeft + 's';
        
        if (timeLeft <= 10) {
          timerDisplay.style.color = '#f44336';
        } else if (timeLeft <= 30) {
          timerDisplay.style.color = '#ff9800';
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          document.getElementById('typed').disabled = true;
          calculate();
        }
      }, 1000);
    }
document.getElementById('rbt').addEventListener('click', () => {
  location.reload(); 
});
    loadParagraph();
  </script>
</body>
</html>